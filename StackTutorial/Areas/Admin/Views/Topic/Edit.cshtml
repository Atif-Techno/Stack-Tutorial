@model StackTutorial.Models.TopicModel
@{
    ViewData["Title"] = "Edit Topic";
    Layout = "_LayoutAdmin";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Edit Topic</h1>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>

    <!-- Validation Summary -->
    <div asp-validation-summary="All" class="alert alert-danger mb-4 @(!ViewData.ModelState.IsValid ? "d-block" : "d-none")">
        <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
        <strong><i class="fas fa-exclamation-circle me-2"></i>Please fix the following errors:</strong>
        <ul class="mb-0 mt-2">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form asp-action="Edit" method="post" id="topicForm">
                <input type="hidden" asp-for="TopicID" />
                <input type="hidden" asp-for="CreatedDate" />
                <input type="hidden" asp-for="CreatedBy" />

                <div class="row g-3">
                    <!-- Title -->
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="Title" class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control" placeholder="Enter topic title" />
                            <span asp-validation-for="Title" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Order -->
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Order" class="form-label fw-semibold">Display Order</label>
                            <input asp-for="Order" class="form-control" type="number" min="0" />
                            <span asp-validation-for="Order" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Slug -->
                    <div class="col-12">
                        <div class="form-group">
                            <label asp-for="Slug" class="form-label fw-semibold">URL Slug</label>
                            <div class="input-group">
                                <input asp-for="Slug" class="form-control" placeholder="topic-slug" />
                                <button type="button" class="btn btn-outline-secondary" id="generate-slug" title="Generate from title">
                                    <i class="fas fa-sync-alt me-1"></i> Generate
                                </button>
                            </div>
                            <span asp-validation-for="Slug" class="text-danger small"></span>
                            <small class="form-text text-muted">Lowercase letters, numbers and hyphens only</small>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="col-12">
                        <div class="form-group">
                            <label asp-for="Description" class="form-label fw-semibold">Description</label>
                            <textarea asp-for="Description" class="form-control" rows="3" placeholder="Brief description of the topic"></textarea>
                            <span asp-validation-for="Description" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Meta Description -->
                    <div class="col-12">
                        <div class="form-group">
                            <label asp-for="MetaDescription" class="form-label fw-semibold">Meta Description</label>
                            <textarea asp-for="MetaDescription" class="form-control" rows="2" maxlength="160"
                                      placeholder="Brief description for search engines"></textarea>
                            <small class="form-text text-muted"><span id="metaCounter">@(Model.MetaDescription?.Length ?? 0)</span>/160 characters</small>
                            <span asp-validation-for="MetaDescription" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Category and Status -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="CategoryID" class="form-label fw-semibold">Category <span class="text-danger">*</span></label>
                            <select asp-for="CategoryID" class="form-select" asp-items="ViewBag.Categories">
                                <option value="">-- Select Category --</option>
                            </select>
                            <span asp-validation-for="CategoryID" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch pt-4">
                            <input type="checkbox" class="form-check-input" role="switch" asp-for="IsActive" />
                            <label class="form-check-label fw-semibold" asp-for="IsActive"></label>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary px-4">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Auto-generate slug from title
        document.getElementById('generate-slug').addEventListener('click', function() {
            const title = document.getElementById('Title').value;
            if (!title) {
                alert('Please enter a title first');
                return;
            }

            const slug = title.toLowerCase()
                .replace(/[^\w\s-]/g, '')  // Remove non-word chars
                .replace(/\s+/g, '-')       // Replace spaces with -
                .replace(/--+/g, '-')       // Replace multiple - with single -
                .trim();                    // Trim - from start/end

            document.getElementById('Slug').value = slug;
        });

        // Auto-generate slug when title loses focus (if slug is empty)
        document.getElementById('Title').addEventListener('blur', function() {
            if (!document.getElementById('Slug').value) {
                document.getElementById('generate-slug').click();
            }
        });

        // Character counter for meta description
        document.getElementById('MetaDescription').addEventListener('input', function() {
            const counter = document.getElementById('metaCounter');
            counter.textContent = this.value.length;
            if (this.value.length > 160) {
                counter.classList.add('text-danger');
            } else {
                counter.classList.remove('text-danger');
            }
        });

        // Form validation before submission
        document.getElementById('topicForm').addEventListener('submit', function(e) {
            const title = document.getElementById('Title').value;
            if (!title || title.trim() === '') {
                e.preventDefault();
                alert('Title is required');
                return false;
            }

            const category = document.getElementById('CategoryID').value;
            if (!category || category <= 0) {
                e.preventDefault();
                alert('Please select a valid category');
                return false;
            }

            return true;
        });
    </script>
}