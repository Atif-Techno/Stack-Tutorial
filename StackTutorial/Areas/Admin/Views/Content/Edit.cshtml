@model StackTutorial.Models.ContentModel
@{
    ViewData["Title"] = "Edit Content";
    Layout = "_LayoutAdmin";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Edit Content</h1>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to List
        </a>
    </div>

    <!-- Validation Summary -->
    <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4 @(!ViewData.ModelState.IsValid ? "d-block" : "d-none")">
        <button type="button" class="btn-close float-end" data-bs-dismiss="alert" aria-label="Close"></button>
        <strong><i class="fas fa-exclamation-circle me-2"></i>Please fix the following errors:</strong>
        <ul class="mb-0 mt-2">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <form asp-action="Edit" method="post" id="contentForm">
                <input type="hidden" asp-for="ContentID" />
                <input type="hidden" asp-for="CreatedDate" />
                <input type="hidden" asp-for="CreatedBy" />

                <div class="row g-3">
                    <!-- Title and Order -->
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="Title" class="form-label fw-semibold">Content Title <span class="text-danger">*</span></label>
                            <input asp-for="Title" class="form-control" placeholder="Enter content title" />
                            <span asp-validation-for="Title" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label asp-for="Order" class="form-label fw-semibold">Display Order</label>
                            <input asp-for="Order" class="form-control" type="number" min="0" />
                            <span asp-validation-for="Order" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Slug Field -->
                    <div class="col-12">
                        <div class="form-group">
                            <label asp-for="Slug" class="form-label fw-semibold">URL Slug</label>
                            <div class="input-group">
                                <input asp-for="Slug" class="form-control" placeholder="auto-generated-slug" />
                                <button type="button" class="btn btn-outline-secondary" id="generate-slug" title="Generate from title">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <span asp-validation-for="Slug" class="text-danger small"></span>
                            <small class="form-text text-muted">Leave blank to auto-generate or use lowercase letters, numbers and hyphens</small>
                        </div>
                    </div>

                    <!-- Content Body -->
                    <div class="col-12">
                        <div class="form-group">
                            <label asp-for="Body" class="form-label fw-semibold">Content <span class="text-danger">*</span></label>
                            <textarea asp-for="Body" class="form-control" id="Body" rows="10"></textarea>
                            <span asp-validation-for="Body" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Topic and Meta Description -->
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="TopicID" class="form-label fw-semibold">Topic <span class="text-danger">*</span></label>
                            <select asp-for="TopicID" class="form-select" asp-items="ViewBag.Topics">
                                <option value="">-- Select Topic --</option>
                            </select>
                            <span asp-validation-for="TopicID" class="text-danger small"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MetaDescription" class="form-label fw-semibold">Meta Description</label>
                            <textarea asp-for="MetaDescription" class="form-control" rows="2" maxlength="160"
                                      placeholder="Brief description for search engines"></textarea>
                            <small class="form-text text-muted"><span id="metaCounter">0</span>/160 characters</small>
                            <span asp-validation-for="MetaDescription" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Status and Actions -->
                    <div class="col-12">
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input" role="switch" asp-for="IsActive" />
                            <label class="form-check-label fw-semibold" asp-for="IsActive"></label>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary px-4" id="submitButton">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary px-4">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- TinyMCE -->
    <script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // Initialize TinyMCE
        tinymce.init({
            selector: '#Body',
            height: 500,
            menubar: false,
            plugins: 'lists link image table code help wordcount',
            toolbar: 'undo redo | blocks | bold italic underline strikethrough | ' +
                     'alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | ' +
                     'link image table | code help',
            branding: false,
            content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:14px }',
            setup: function(editor) {
                editor.on('change', function () {
                    editor.save();
                });
            }
        });

        // Generate slug from title
        document.getElementById('generate-slug').addEventListener('click', function() {
            const title = document.getElementById('Title').value;
            const slug = title.toLowerCase()
                .replace(/[^\w\s-]/g, '')  // Remove non-word chars
                .replace(/\s+/g, '-')       // Replace spaces with -
                .replace(/--+/g, '-')       // Replace multiple - with single -
                .trim();                    // Trim - from start/end

            document.getElementById('Slug').value = slug;
        });

        // Character counter for meta description
        document.getElementById('MetaDescription').addEventListener('input', function() {
            const counter = document.getElementById('metaCounter');
            counter.textContent = this.value.length;
            if (this.value.length > 160) {
                counter.classList.add('text-danger');
            } else {
                counter.classList.remove('text-danger');
            }
        });

        // Initialize counter on page load
        document.addEventListener('DOMContentLoaded', function() {
            const metaDesc = document.getElementById('MetaDescription');
            document.getElementById('metaCounter').textContent = metaDesc.value.length;
        });

        // Form submission handler
        document.getElementById('contentForm').addEventListener('submit', function() {
            tinymce.triggerSave();
            return true;
        });
    </script>
}